\hypertarget{settrie_8h_source}{}\doxysection{settrie.\+h}
\label{settrie_8h_source}\index{settrie/settrie.h@{settrie/settrie.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/* Mercury-\/Settrie}}
\DoxyCodeLine{2 \textcolor{comment}{}}
\DoxyCodeLine{3 \textcolor{comment}{    Copyright 2023 Banco Bilbao Vizcaya Argentaria, S.A.}}
\DoxyCodeLine{4 \textcolor{comment}{}}
\DoxyCodeLine{5 \textcolor{comment}{    This product includes software developed at}}
\DoxyCodeLine{6 \textcolor{comment}{}}
\DoxyCodeLine{7 \textcolor{comment}{    BBVA (https://www.bbva.com/)}}
\DoxyCodeLine{8 \textcolor{comment}{}}
\DoxyCodeLine{9 \textcolor{comment}{      Licensed under the Apache License, Version 2.0 (the "{}License"{});}}
\DoxyCodeLine{10 \textcolor{comment}{    you may not use this file except in compliance with the License.}}
\DoxyCodeLine{11 \textcolor{comment}{    You may obtain a copy of the License at}}
\DoxyCodeLine{12 \textcolor{comment}{}}
\DoxyCodeLine{13 \textcolor{comment}{    http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{14 \textcolor{comment}{}}
\DoxyCodeLine{15 \textcolor{comment}{      Unless required by applicable law or agreed to in writing, software}}
\DoxyCodeLine{16 \textcolor{comment}{    distributed under the License is distributed on an "{}AS IS"{} BASIS,}}
\DoxyCodeLine{17 \textcolor{comment}{    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.}}
\DoxyCodeLine{18 \textcolor{comment}{    See the License for the specific language governing permissions and}}
\DoxyCodeLine{19 \textcolor{comment}{    limitations under the License.}}
\DoxyCodeLine{20 \textcolor{comment}{*/}}
\DoxyCodeLine{21 \textcolor{preprocessor}{\#ifndef INCLUDED\_SETTRIE}}
\DoxyCodeLine{22 \textcolor{preprocessor}{\#define INCLUDED\_SETTRIE}}
\DoxyCodeLine{23 }
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include <algorithm>}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include <functional>}}
\DoxyCodeLine{26 \textcolor{preprocessor}{\#include <map>}}
\DoxyCodeLine{27 \textcolor{preprocessor}{\#include <string>}}
\DoxyCodeLine{28 \textcolor{preprocessor}{\#include <vector>}}
\DoxyCodeLine{29 }
\DoxyCodeLine{30 \textcolor{preprocessor}{\#define IMAGE\_BUFF\_SIZE                 6136}}
\DoxyCodeLine{31 }
\DoxyCodeLine{32 \textcolor{keyword}{typedef} uint64\_t                        ElementHash;}
\DoxyCodeLine{33 \textcolor{keyword}{typedef} std::string                     String;}
\DoxyCodeLine{34 }
\DoxyCodeLine{35 \textcolor{keyword}{typedef} std::vector<ElementHash>        BinarySet;}
\DoxyCodeLine{36 \textcolor{keyword}{typedef} std::vector<String>             StringSet;}
\DoxyCodeLine{37 \textcolor{keyword}{typedef} std::vector<int>                IdList;}
\DoxyCodeLine{38 }
\DoxyCodeLine{39 \textcolor{keyword}{typedef} std::map<ElementHash, String>   StringName;}
\DoxyCodeLine{40 \textcolor{keyword}{typedef} std::map<int, String>           IdMap;}
\DoxyCodeLine{41 }
\DoxyCodeLine{42 \textcolor{keyword}{struct }\mbox{\hyperlink{structSetNode}{SetNode}} \{}
\DoxyCodeLine{43     ElementHash value;}
\DoxyCodeLine{44 }
\DoxyCodeLine{45     \textcolor{keywordtype}{int} idx\_next, idx\_child;}
\DoxyCodeLine{46 }
\DoxyCodeLine{47     \textcolor{keywordtype}{bool} is\_flaged;}
\DoxyCodeLine{48 \};}
\DoxyCodeLine{49 }
\DoxyCodeLine{50 \textcolor{keyword}{typedef} std::vector<SetNode>            BinaryTree;}
\DoxyCodeLine{51 }
\DoxyCodeLine{52 \textcolor{comment}{// This structure is 64encoded to 8K (3 input bytes == 24 bit -\/> 4 output chars == 24 bit). Therefore, its size is 6K.}}
\DoxyCodeLine{53 \textcolor{keyword}{struct }\mbox{\hyperlink{structImageBlock}{ImageBlock}} \{}
\DoxyCodeLine{54     \textcolor{keywordtype}{int} size, block\_num;}
\DoxyCodeLine{55 }
\DoxyCodeLine{56     uint8\_t buffer[IMAGE\_BUFF\_SIZE];        \textcolor{comment}{// makes sizeof(ImageBlock) == 6K}}
\DoxyCodeLine{57 \};}
\DoxyCodeLine{58 }
\DoxyCodeLine{59 \textcolor{keyword}{typedef} std::vector<ImageBlock>         BinaryImage;}
\DoxyCodeLine{60 \textcolor{keyword}{typedef} BinaryImage                    *pBinaryImage;}
\DoxyCodeLine{61 }
\DoxyCodeLine{62 }
\DoxyCodeLine{63 \textcolor{keyword}{class }\mbox{\hyperlink{classSetTrie}{SetTrie}} \{}
\DoxyCodeLine{64 }
\DoxyCodeLine{65     \textcolor{keyword}{public}:}
\DoxyCodeLine{66 }
\DoxyCodeLine{67         \mbox{\hyperlink{classSetTrie}{SetTrie}}() \{}
\DoxyCodeLine{68             \mbox{\hyperlink{structSetNode}{SetNode}} root = \{0, 0, 0, \textcolor{keyword}{false}\};}
\DoxyCodeLine{69             tree.push\_back(root);}
\DoxyCodeLine{70         \}}
\DoxyCodeLine{71 }
\DoxyCodeLine{72         \textcolor{keywordtype}{void}      insert    (StringSet set, String \textcolor{keywordtype}{id});}
\DoxyCodeLine{73         \textcolor{keywordtype}{void}      insert    (String str, String str\_id, \textcolor{keywordtype}{char} split);}
\DoxyCodeLine{74         String    find      (StringSet set);}
\DoxyCodeLine{75         String    find      (String str, \textcolor{keywordtype}{char} split);}
\DoxyCodeLine{76         StringSet supersets (StringSet set);}
\DoxyCodeLine{77         StringSet supersets (String str, \textcolor{keywordtype}{char} split);}
\DoxyCodeLine{78         StringSet subsets   (StringSet set);}
\DoxyCodeLine{79         StringSet subsets   (String str, \textcolor{keywordtype}{char} split);}
\DoxyCodeLine{80         \textcolor{keywordtype}{bool}      load      (pBinaryImage \&p\_bi);}
\DoxyCodeLine{81         \textcolor{keywordtype}{bool}      save      (pBinaryImage \&p\_bi);}
\DoxyCodeLine{82 }
\DoxyCodeLine{83 \textcolor{preprocessor}{\#ifndef TEST}}
\DoxyCodeLine{84     \textcolor{keyword}{private}:}
\DoxyCodeLine{85 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{86 }
\DoxyCodeLine{87     \textcolor{keyword}{inline} \textcolor{keywordtype}{int} insert(\textcolor{keywordtype}{int} idx, ElementHash value) \{}
\DoxyCodeLine{88 }
\DoxyCodeLine{89         \textcolor{keywordflow}{if} (tree[idx].idx\_child == 0) \{}
\DoxyCodeLine{90 }
\DoxyCodeLine{91             \mbox{\hyperlink{structSetNode}{SetNode}} node = \{value, 0, 0, \textcolor{keyword}{false}\};}
\DoxyCodeLine{92 }
\DoxyCodeLine{93             tree.push\_back(node);}
\DoxyCodeLine{94 }
\DoxyCodeLine{95             \textcolor{keywordtype}{int} idx\_c = tree.size() -\/ 1;}
\DoxyCodeLine{96 }
\DoxyCodeLine{97             tree[idx].idx\_child = idx\_c;}
\DoxyCodeLine{98 }
\DoxyCodeLine{99             \textcolor{keywordflow}{return} idx\_c;}
\DoxyCodeLine{100         \}}
\DoxyCodeLine{101 }
\DoxyCodeLine{102         idx = tree[idx].idx\_child;}
\DoxyCodeLine{103 }
\DoxyCodeLine{104         \textcolor{keywordflow}{while} (\textcolor{keyword}{true}) \{}
\DoxyCodeLine{105             \textcolor{keywordflow}{if} (tree[idx].value == value)}
\DoxyCodeLine{106                 \textcolor{keywordflow}{return} idx;}
\DoxyCodeLine{107 }
\DoxyCodeLine{108             \textcolor{keywordflow}{if} (tree[idx].idx\_next == 0) \{}
\DoxyCodeLine{109                 \mbox{\hyperlink{structSetNode}{SetNode}} node = \{value, 0, 0, \textcolor{keyword}{false}\};}
\DoxyCodeLine{110 }
\DoxyCodeLine{111                 tree.push\_back(node);}
\DoxyCodeLine{112 }
\DoxyCodeLine{113                 \textcolor{keywordtype}{int} idx\_c = tree.size() -\/ 1;}
\DoxyCodeLine{114 }
\DoxyCodeLine{115                 tree[idx].idx\_next = idx\_c;}
\DoxyCodeLine{116 }
\DoxyCodeLine{117                 \textcolor{keywordflow}{return} idx\_c;}
\DoxyCodeLine{118             \}}
\DoxyCodeLine{119 }
\DoxyCodeLine{120             idx = tree[idx].idx\_next;}
\DoxyCodeLine{121         \}}
\DoxyCodeLine{122     \}}
\DoxyCodeLine{123 }
\DoxyCodeLine{124     \textcolor{keyword}{inline} \textcolor{keywordtype}{int} insert(BinarySet set) \{}
\DoxyCodeLine{125 }
\DoxyCodeLine{126         \textcolor{keywordtype}{int} idx  = 0;}
\DoxyCodeLine{127         \textcolor{keywordtype}{int} size = set.size();}
\DoxyCodeLine{128 }
\DoxyCodeLine{129         \textcolor{keywordflow}{if} (size == 0) \{}
\DoxyCodeLine{130             tree[0].is\_flaged = \textcolor{keyword}{true};}
\DoxyCodeLine{131 }
\DoxyCodeLine{132             \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{133         \}}
\DoxyCodeLine{134 }
\DoxyCodeLine{135         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < size; i++)}
\DoxyCodeLine{136             idx = insert(idx, set[i]);}
\DoxyCodeLine{137 }
\DoxyCodeLine{138         tree[idx].is\_flaged = \textcolor{keyword}{true};}
\DoxyCodeLine{139 }
\DoxyCodeLine{140         \textcolor{keywordflow}{return} idx;}
\DoxyCodeLine{141     \}}
\DoxyCodeLine{142 }
\DoxyCodeLine{143     \textcolor{keyword}{inline} \textcolor{keywordtype}{int} find(\textcolor{keywordtype}{int} idx, ElementHash value) \{}
\DoxyCodeLine{144 }
\DoxyCodeLine{145         \textcolor{keywordflow}{if} ((idx = tree[idx].idx\_child) == 0)}
\DoxyCodeLine{146             \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{147 }
\DoxyCodeLine{148         \textcolor{keywordflow}{while} (\textcolor{keyword}{true}) \{}
\DoxyCodeLine{149             \textcolor{keywordflow}{if} (tree[idx].value == value)}
\DoxyCodeLine{150                 \textcolor{keywordflow}{return} idx;}
\DoxyCodeLine{151 }
\DoxyCodeLine{152             \textcolor{keywordflow}{if} ((idx = tree[idx].idx\_next) == 0)}
\DoxyCodeLine{153                 \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{154         \}}
\DoxyCodeLine{155     \}}
\DoxyCodeLine{156 }
\DoxyCodeLine{157     \textcolor{keyword}{inline} \textcolor{keywordtype}{int} find(BinarySet set) \{}
\DoxyCodeLine{158 }
\DoxyCodeLine{159         \textcolor{keywordtype}{int} idx  = 0;}
\DoxyCodeLine{160         \textcolor{keywordtype}{int} size = set.size();}
\DoxyCodeLine{161 }
\DoxyCodeLine{162         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < size; i++)}
\DoxyCodeLine{163             \textcolor{keywordflow}{if} ((idx = find(idx, set[i])) == 0)}
\DoxyCodeLine{164                 \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{165 }
\DoxyCodeLine{166         \textcolor{keywordflow}{return} idx;}
\DoxyCodeLine{167     \}}
\DoxyCodeLine{168 }
\DoxyCodeLine{169     \textcolor{keyword}{inline} \textcolor{keywordtype}{void} all\_supersets(\textcolor{keywordtype}{int} t\_idx) \{}
\DoxyCodeLine{170 }
\DoxyCodeLine{171         \textcolor{keywordflow}{while} (t\_idx != 0) \{}
\DoxyCodeLine{172             \textcolor{keywordflow}{if} (tree[t\_idx].is\_flaged)}
\DoxyCodeLine{173                 result.push\_back(t\_idx);}
\DoxyCodeLine{174 }
\DoxyCodeLine{175             \textcolor{keywordflow}{if} (\textcolor{keywordtype}{int} ci = tree[t\_idx].idx\_child)}
\DoxyCodeLine{176                 all\_supersets(ci);}
\DoxyCodeLine{177 }
\DoxyCodeLine{178             t\_idx = tree[t\_idx].idx\_next;}
\DoxyCodeLine{179         \}}
\DoxyCodeLine{180     \}}
\DoxyCodeLine{181 }
\DoxyCodeLine{182     \textcolor{keyword}{inline} \textcolor{keywordtype}{void} supersets(\textcolor{keywordtype}{int} t\_idx, \textcolor{keywordtype}{int} s\_idx) \{}
\DoxyCodeLine{183 }
\DoxyCodeLine{184         \textcolor{keywordflow}{while} (t\_idx != 0) \{}
\DoxyCodeLine{185             ElementHash t\_value, q\_value;}
\DoxyCodeLine{186 }
\DoxyCodeLine{187             \textcolor{keywordtype}{int} found = 0;}
\DoxyCodeLine{188 }
\DoxyCodeLine{189             \textcolor{keywordflow}{if} ((t\_value = tree[t\_idx].value) == (q\_value = query[s\_idx])) \{}
\DoxyCodeLine{190                 \textcolor{keywordflow}{if} (s\_idx == last\_query\_idx) \{}
\DoxyCodeLine{191 }
\DoxyCodeLine{192                     \textcolor{keywordflow}{if} (tree[t\_idx].is\_flaged)}
\DoxyCodeLine{193                         result.push\_back(t\_idx);}
\DoxyCodeLine{194 }
\DoxyCodeLine{195                     \textcolor{keywordflow}{if} (\textcolor{keywordtype}{int} ci = tree[t\_idx].idx\_child)}
\DoxyCodeLine{196                         all\_supersets(ci);}
\DoxyCodeLine{197 }
\DoxyCodeLine{198                 \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{199                     found = 1;}
\DoxyCodeLine{200                     q\_value = query[s\_idx + 1];}
\DoxyCodeLine{201                 \}}
\DoxyCodeLine{202             \}}
\DoxyCodeLine{203 }
\DoxyCodeLine{204             \textcolor{keywordtype}{int} ni;}
\DoxyCodeLine{205             \textcolor{keywordflow}{if} (t\_value < q\_value \&\& (ni = tree[t\_idx].idx\_child) != 0)}
\DoxyCodeLine{206                 supersets(ni, s\_idx + found);}
\DoxyCodeLine{207 }
\DoxyCodeLine{208             t\_idx = tree[t\_idx].idx\_next;}
\DoxyCodeLine{209         \}}
\DoxyCodeLine{210     \}}
\DoxyCodeLine{211 }
\DoxyCodeLine{212     \textcolor{keyword}{inline} \textcolor{keywordtype}{void} subsets(\textcolor{keywordtype}{int} t\_idx, \textcolor{keywordtype}{int} s\_idx) \{}
\DoxyCodeLine{213 }
\DoxyCodeLine{214         \textcolor{keywordflow}{while} (t\_idx != 0) \{}
\DoxyCodeLine{215             ElementHash t\_value;}
\DoxyCodeLine{216             \textcolor{keywordflow}{if} ((t\_value = tree[t\_idx].value) >= query[s\_idx]) \{}
\DoxyCodeLine{217                 \textcolor{keywordtype}{int} ns\_idx = s\_idx;}
\DoxyCodeLine{218 }
\DoxyCodeLine{219                 \textcolor{keywordflow}{while} (ns\_idx < last\_query\_idx \&\& query[ns\_idx] < t\_value)}
\DoxyCodeLine{220                     ns\_idx++;}
\DoxyCodeLine{221 }
\DoxyCodeLine{222                 \textcolor{keywordflow}{if} (query[ns\_idx] == t\_value) \{}
\DoxyCodeLine{223                     \textcolor{keywordflow}{if} (tree[t\_idx].is\_flaged)}
\DoxyCodeLine{224                         result.push\_back(t\_idx);}
\DoxyCodeLine{225 }
\DoxyCodeLine{226                     \textcolor{keywordtype}{int} ni;}
\DoxyCodeLine{227                     \textcolor{keywordflow}{if} ((ni = tree[t\_idx].idx\_child) != 0) \{}
\DoxyCodeLine{228                         ns\_idx++;}
\DoxyCodeLine{229 }
\DoxyCodeLine{230                         \textcolor{keywordflow}{if} (ns\_idx <= last\_query\_idx)}
\DoxyCodeLine{231                             subsets(ni, ns\_idx);}
\DoxyCodeLine{232                     \}}
\DoxyCodeLine{233                 \}}
\DoxyCodeLine{234             \}}
\DoxyCodeLine{235 }
\DoxyCodeLine{236             t\_idx = tree[t\_idx].idx\_next;}
\DoxyCodeLine{237         \}}
\DoxyCodeLine{238     \}}
\DoxyCodeLine{239 }
\DoxyCodeLine{240     \textcolor{keywordtype}{int} last\_query\_idx;}
\DoxyCodeLine{241 }
\DoxyCodeLine{242     BinarySet  query  = \{\};}
\DoxyCodeLine{243     IdList     result = \{\};}
\DoxyCodeLine{244     BinaryTree tree   = \{\};}
\DoxyCodeLine{245     StringName name   = \{\};}
\DoxyCodeLine{246     IdMap      \textcolor{keywordtype}{id}     = \{\};}
\DoxyCodeLine{247 \};}
\DoxyCodeLine{248 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
